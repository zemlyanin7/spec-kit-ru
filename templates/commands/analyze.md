---
description: Провести ненарушающий анализ согласованности и качества между spec.md, plan.md и tasks.md после генерации задач.
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ОБЯЗАНЫ** учитывать ввод пользователя перед началом анализа (если он не пустой).

## Цель

Обнаружить несогласованности, дубли, двусмысленности и недоопределённые области в трёх основных артефактах (`spec.md`, `plan.md`, `tasks.md`) до начала реализации. Команда **запускается только после** успешного выполнения `/tasks`, когда `tasks.md` уже сформирован.

## Ограничения

- **Только чтение**: Никаких изменений файлов. Выдайте структурированный отчёт и при желании предложите план исправлений (пользователь должен явно подтвердить дальнейшие действия).
- **Приоритет конституции**: `/memory/constitution.md` является непреложным источником правил. Конфликты с принципами автоматически получают уровень CRITICAL и должны устраняться в спецификации/плане/списке задач. Изменение самой конституции — отдельный процесс вне `/analyze`.

## Шаги выполнения

### 1. Инициализация контекста

Запустите `{SCRIPT}` из корня репозитория и извлеките из JSON значения `FEATURE_DIR` и `AVAILABLE_DOCS`. Постройте абсолютные пути:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

Если какого-либо файла нет — завершите работу с подсказкой, какую команду запустить. Экранируйте аргументы с `'` как `'I'\''m Groot'` или используйте двойные кавычки.

### 2. Загрузка артефактов (по потребности)

Считывайте только необходимый минимум:

- **spec.md**: обзор/контекст, функциональные и нефункциональные требования, пользовательские истории, Edge Cases.
- **plan.md**: архитектура/стек, модель данных, фазы, технические ограничения.
- **tasks.md**: идентификаторы задач, описания, фазы, метки [P], пути к файлам.
- **Конституция**: весь `/memory/constitution.md` для проверки принципов.

### 3. Построение семантических моделей

Создайте внутренние представления (не выводите их напрямую):

- Каталог требований (FN/NFR) с устойчивыми ключами (slug по формулировке).
- Каталог пользовательских действий / историй и критериев.
- Покрытие задач: сопоставьте каждую задачу с требованиями/историями (по ключевым словам/ID).
- Множество правил конституции (принципы и формулировки MUST/SHOULD).

### 4. Поиск проблем (фокус на ключевом)

Ограничьте обнаруженные пункты 50 строками в отчёте, остальное упомяните в сводке.

- **Дубли**: близкие формулировки требований → отметьте, какую оставить.
- **Двусмысленности**: размытые прилагательные без метрик, незаполненные плейсхолдеры.
- **Недоопределённость**: требования без конкретного результата, истории без связи с критериям, задачи с файлами, не описанными в спецификации/плане.
- **Конфликты с конституцией**: любые нарушения MUST-положений → CRITICAL.
- **Покрытие**: требования без задач, задачи без требований, нефункциональные требования без задач.
- **Несогласованность**: разная терминология, сущности в планe, отсутствующие в спецификации, противоречивый порядок задач, conflicting tech choices.

### 5. Оценка серьёзности

- **CRITICAL**: нарушение конституции, отсутствующее ключевое требование, нулевая покрываемость критичного требования.
- **HIGH**: конфликтующие или дублирующие требования, неоднозначная безопасность/производительность, невалидный acceptance критерий.
- **MEDIUM**: терминологические расхождения, отсутствие задач по НФТ, неуточнённые edge cases.
- **LOW**: стилистика, лёгкие дубли, не влияющие на выполнение.

### 6. Отчёт об анализе

Сформируйте Markdown-отчёт:

#### Specification Analysis Report

| ID | Категория | Severity | Локация | Сводка | Рекомендация |
|----|-----------|----------|---------|--------|---------------|
| A1 | Duplication | HIGH | spec.md:L120-134 | ... | ... |

**Сводка покрытия**:

| Requirement Key | Есть задача? | Task IDs | Примечания |
|-----------------|--------------|----------|------------|

**Нарушения конституции** (если есть)

**Задачи без требований** (если есть)

**Метрики**:

- Всего требований
- Всего задач
- % покрытия (требования с ≥1 задачей)
- Количество двусмысленностей
- Количество дублей
- Количество критичных проблем

### 7. Следующие действия

В конце отчёта добавьте блок Next Actions:

- Если есть CRITICAL — рекомендовать исправить до `/specify-ru.implement`.
- Если только LOW/MEDIUM — указать, что можно двигаться дальше, но перечислить улучшения.
- Предложить конкретные команды/действия: например, повторное уточнение спецификации, правка плана, обновление tasks.md.

### 8. Предложение remediation

Спросите: «Хотите, чтобы я предложил конкретные шаги по исправлению топ-N проблем?»  
Никаких автоматических правок.

## Принципы работы

- **Эффективность**: минимизировать объём загружаемых данных и выводимого текста.
- **Повторяемость**: одинаковый ввод → одинаковый анализ.
- **Отсутствие правок**: только чтение.
- **Честность**: ничего не выдумывать.
- **Приоритет конституции**: сразу помечать нарушения.
- **Отчёт без шумов**: максимум 50 строк с находками + сводка.
- **Корректное завершение**: если проблем нет — сообщите об этом, приведите метрики.

## Контекст

{ARGS}
