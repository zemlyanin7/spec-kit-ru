---
description: Выявить недоопределённые области текущей спецификации фичи, задать до 5 точечных вопросов на уточнение и зафиксировать ответы в самой спецификации.
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ОБЯЗАНЫ** учитывать ввод пользователя перед продолжением (если он не пустой).

## Общий план

Цель: обнаружить двусмысленности или отсутствующие решения в активной спецификации и зафиксировать уточнения непосредственно в файле спецификации.

> Примечание: Этот процесс следует завершить ДО запуска `/speckit.plan`. Если пользователь явно сообщает, что пропускает уточнения (например, исследовательский спайк), допускается продолжить, но нужно предупредить о повышенном риске переделок.

### Шаги выполнения

1. Запустите `{SCRIPT}` из корня репозитория **один раз** (режим `--json --paths-only` / `-Json -PathsOnly`). Извлеките из JSON:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - (Опционально сохраните `IMPL_PLAN`, `TASKS` для последующих команд.)
   - Если парсинг JSON не удался — прервитесь и сообщите пользователю о необходимости повторно выполнить `/speckit.specify` или проверить ветку.
   - Для строк с апострофами используйте экранирование `'I'\''m Groot'` либо двойные кавычки.

2. Загрузите текущий файл спецификации и выполните структурный аудит по следующим категориям, отмечая статус: **Clear / Partial / Missing**. Сформируйте внутреннюю карту покрытия (не выводите её напрямую, если планируются вопросы).

   **Функциональный объём и поведение**:
   - Основные пользовательские цели и критерии успеха
  - Явно исключённые сценарии
  - Различия ролей/персон

   **Домен и модель данных**:
   - Сущности, атрибуты, связи
   - Правила идентичности/уникальности
   - Жизненный цикл / переходы состояний
   - Объёмы данных, допущения по масштабу

   **Взаимодействие и UX**:
   - Критические пользовательские потоки
   - Состояния ошибок/пустых/загрузки
   - Требования по доступности, локализации

   **Нефункциональные характеристики**:
   - Производительность (латентность, пропускная способность)
   - Масштабируемость (по горизонтали/вертикали, лимиты)
   - Надёжность и доступность (uptime, восстановление)
   - Наблюдаемость (логирование, метрики, трассировка)
   - Безопасность и приватность (authN/Z, защита данных, угрозы)
   - Соответствие нормам (если применимо)

   **Интеграции и внешние зависимости**:
   - Внешние сервисы/API и их отказоустойчивость
   - Форматы импорта/экспорта данных
   - Протоколы, версии, ожидания

   **Краевые случаи и ошибки**:
   - Негативные сценарии
   - Лимиты, throttle, rate limiting
   - Разрешение конфликтов (конкурентные обновления и т.п.)

   **Ограничения и компромиссы**:
   - Технические ограничения (язык, хранилище, хостинг)
   - Явные компромиссы/отказанные альтернативы

   **Терминология и согласованность**:
   - Канонический глоссарий
   - Избегаемые синонимы / устаревшие термины

   **Критерии завершения**:
   - Тестопригодность критериев приёмки
   - Измеримые признаки «Готово»

   **Прочее / плейсхолдеры**:
   - TODO/XXX
   - Размытые формулировки («надёжный», «интуитивный») без конкретики

   Для категорий со статусом Partial/Missing подготовьте кандидатуры вопросов, кроме случаев когда:
   - Ответ существенно не влияет на реализацию или проверку;
   - Информация логичнее уточняется на этапе планирования (зафиксируйте это внутренне).

3. Сформируйте очередность вопросов (максимум 5). **Не выводите** сразу весь список. Ограничения:
   - За весь сеанс можно задать не более 10 вопросов.
   - Каждый вопрос должен иметь форму:
     * либо короткий выбор из 2–5 взаимоисключающих вариантов;
     * либо короткий свободный ответ (ограничьте: «Ответьте ≤5 словами»).
   - Включайте только вопросы, значимые для архитектуры, модели данных, декомпозиции задач, UX, эксплуатации или комплаенса.
   - Балансируйте категории — приоритет по (влияние × неопределённость).
   - Исключайте уже отвеченные темы, стилистические предпочтения, детали реализации (если они не критичны).
   - Если кандидатов больше 5 — выберите топ-5 по критерию Impact * Uncertainty.

4. **Интерактивный цикл вопросов**:
   - Показывайте строго по одному вопросу.
   - Для вариантов ответов:
     - Проанализируйте каждую опцию и выберите рекомендуемую (учтите лучшие практики, риски). Чётко укажите выбранную опцию.
     - Укажите: безопасность, производительность, устойчивость, опыт использования, технические риски, зачем этот выбор.
     - Разрешайте выбросить на голосование «другое» — пользователь может предложить свободный ответ.
   - Для свободных ответов:
     - Чётко сформулируйте вопрос и ограничения («≤5 слов», «одно предложение»).
   - После рекомендации попросите пользователя подтвердить или предоставить иной вариант.
   - Форматировать вопросы нумерованным списком, например:
     ```
     Q1 (категория: Security / Privacy)
     Вопрос…
     Варианты:
     A) …
     B) …
     C) Свой вариант — напишите <=5 слов.
     
     По умолчанию: A (обоснование…)
     
     Как выбираете?
     ```
   - После ответов интегрируйте изменения (см. пункт 5).
   - Завершайте цикл, когда пользователь удовлетворён («done», «достаточно», «продолжаем») или когда задано 5 вопросов.
   - Не раскрывайте вопросы из очереди заранее.
   - Если подходящих вопросов нет — сразу сообщите, что критичных неясностей не обнаружено.

5. **Интеграция ответа (после каждого подтверждения)**:
   - Работайте с внутренним представлением спецификации (загруженной один раз).
   - Если это первое уточнение в текущей сессии:
     - Убедитесь, что есть раздел `## Clarifications` (создайте сразу после обзорных разделов, если отсутствует).
     - Создайте (при необходимости) подраздел `### Session YYYY-MM-DD` для текущей даты.
   - Добавьте строку `- Q: … → A: …` под соответствующим подразделом.
   - Сразу внесите изменения в релевантный раздел спецификации:
     - Функциональный момент → обновить/добавить пункт в Functional Requirements.
     - UX/роли → обновить User Scenarios или Actors.
     - Данные → обновить Data Model (поля, связи).
     - Нефункциональные требования → добавить измеримую метрику в соответствующий раздел.
     - Краевой случай → добавить пункт в Edge Cases.
     - Терминология → заменить по всему документу, оставив пометку `(ранее "X")` при необходимости.
   - Если уточнение делает старую фразу неверной — замените её, не дублируя.
   - Сохраняйте файл после каждого обновления (атомарно).
   - Сохраняйте форматирование и порядок разделов.

6. **Проверка после каждого изменения и финальная**:
   - В разделе Clarifications ровно по одному пункту на вопрос.
   - Всего вопросов ≤ 5.
   - Нет оставшихся «пустых» плейсхолдеров относительно полученного ответа.
   - Нет противоречий с ранее написанным текстом.
   - Markdown валиден; новые заголовки — только `## Clarifications` и `### Session YYYY-MM-DD`.
   - Терминология консистентна.

7. Запишите обновлённую спецификацию в `FEATURE_SPEC`.

8. **Отчёт о завершении** (после цикла или досрочного окончания):
   - Сколько вопросов задано/получено ответов.
   - Путь к обновлённой спецификации.
   - Какие разделы изменены.
   - Таблица покрытия: для каждой категории статус Resolved / Deferred / Clear / Outstanding.
   - Если остались Deferred или Outstanding — объясните почему и дайте рекомендацию (продолжать ли к `/speckit.plan`, повторить уточнение позже и т.д.).
   - Подскажите следующую команду.

### Правила поведения

- Если критичных неясностей нет — сообщите кратко и предложите переходить дальше.
- Если отсутствует файл спецификации — предложите сначала выполнить `/speckit.specify`.
- Не превышайте лимит из 5 вопросов; попытки уточнить один и тот же вопрос считаются одним.
- Не задавайте спекулятивные технологические вопросы, если это не блокирует корректность.
- Соблюдайте пожелания пользователя об остановке.
- Если квота вопросов исчерпана, но остались важные категории — отметьте их в Deferred с пояснением.

Контекст для приоритизации: {ARGS}
